# Content Domain Agent Rules

**Level**: 1 (Domain)
**Role**: ì½˜í…ì¸  ë° í•¸ë“œ ë°ì´í„° ê´€ë¦¬

---

## Identity

| ì†ì„± | ê°’ |
|------|-----|
| **Agent ID** | `content-domain` |
| **Level** | 1 (Domain) |
| **Domain** | Content |
| **Managed Blocks** | content.query, content.cache, content.response, content.hands, content.timeline |
| **Scope** | `apps/web/features/content/`, `packages/agents/content-domain/` |

---

## Block Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CONTENT DOMAIN                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚    query     â”‚â”€â”€â”€â–¶â”‚    cache     â”‚â”€â”€â”€â–¶â”‚   response   â”‚  â”‚
â”‚  â”‚    Block     â”‚    â”‚    Block     â”‚    â”‚    Block     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚  â–¼              â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚    hands     â”‚â”€â”€â”€â–¶â”‚   timeline   â”‚                      â”‚
â”‚  â”‚    Block     â”‚    â”‚    Block     â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                   â”‚                              â”‚
â”‚         â–¼                   â–¼                              â”‚
â”‚  â€¢ í•¸ë“œ ë°ì´í„°         â€¢ íƒ€ì„ë¼ì¸ êµ¬ì¶•                     â”‚
â”‚  â€¢ ë“±ê¸‰ í•„í„°           â€¢ êµ¬ê°„ ì¸ë±ì‹±                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Constraints

### DO (í•´ì•¼ í•  ê²ƒ)
- âœ… `features/content/` í´ë” ë‚´ íŒŒì¼ë§Œ ìˆ˜ì •
- âœ… ëª¨ë“  DB ì¡°íšŒ ì‹œ í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
- âœ… ìºì‹œ í‚¤ì— ë²„ì „ í¬í•¨
- âœ… Eager Loadingìœ¼ë¡œ N+1 ë°©ì§€
- âœ… í•¸ë“œ ë“±ê¸‰ ê¸°ë°˜ í•„í„°ë§ ì œê³µ

### DON'T (í•˜ì§€ ë§ ê²ƒ)
- âŒ `features/` ì™¸ë¶€ íŒŒì¼ ì§ì ‘ ìˆ˜ì •
- âŒ **ë‹¤ë¥¸ ë„ë©”ì¸ì˜ DB í…Œì´ë¸” ì§ì ‘ ì¡°ì‘** (users, sessions ë“±)
- âŒ **E2E í…ŒìŠ¤íŠ¸ì—ì„œ í”„ë¡œë•ì…˜ DB ì‚¬ìš©** (ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸ DB ì‚¬ìš©)
- âŒ ë¬´í•œ ê²°ê³¼ ë°˜í™˜ (limit í•„ìˆ˜)
- âŒ ìºì‹œ ë¬´íš¨í™” ì—†ì´ ë°ì´í„° ìˆ˜ì •
- âŒ Stream ë„ë©”ì¸ ì§ì ‘ í˜¸ì¶œ
- âŒ ë¯¼ê°í•œ ì‚¬ìš©ì ì •ë³´ ë…¸ì¶œ

### ğŸ“Š DB í…Œì´ë¸” ì†Œìœ ê¶Œ

| ì†Œìœ  í…Œì´ë¸” | ì½ê¸° ì „ìš© í…Œì´ë¸” |
|-------------|------------------|
| `catalogs`, `series`, `contents`, `files`, `hands`, `hand_players`, `players` | `users` (FK ì°¸ì¡°ë§Œ) |

---

## Capabilities

| Capability | Input | Output | Description |
|------------|-------|--------|-------------|
| `getContent` | `ContentId` | `ContentDetail` | ì½˜í…ì¸  ìƒì„¸ ì¡°íšŒ |
| `listContents` | `ContentListQuery` | `PaginatedList<Content>` | ì½˜í…ì¸  ëª©ë¡ ì¡°íšŒ |
| `getHands` | `ContentId` | `Hand[]` | í•¸ë“œ ëª©ë¡ ì¡°íšŒ |
| `buildTimeline` | `Hand[]` | `TimelineIndex` | íƒ€ì„ë¼ì¸ ì¸ë±ìŠ¤ ìƒì„± |
| `invalidateCache` | `ContentId` | `void` | ìºì‹œ ë¬´íš¨í™” |

---

## Dependencies

### ë‚´ë¶€ ì˜ì¡´ì„±
- `@wsoptv/types`: ê³µìœ  íƒ€ì… (`Content`, `Hand`, `Episode`)
- `@wsoptv/hands`: í•¸ë“œ ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
- `shared/utils`: ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

### ì™¸ë¶€ ì˜ì¡´ì„±
- `drizzle-orm`: ORM
- `redis`: ìºì‹œ
- `zod`: ìŠ¤í‚¤ë§ˆ ê²€ì¦

---

## Data Models

### Content
```typescript
interface Content {
  id: number;
  catalogId: string;
  title: string;
  episode?: number;
  season?: string;
  fileId: number;
  durationSec: number;
  thumbnailUrl?: string;
}
```

### Hand
```typescript
interface Hand {
  id: number;
  contentId: number;
  handNumber: number;
  grade: 'S' | 'A' | 'B' | 'C';
  startSec: number;
  endSec: number;
  players: string[];
  potSize?: number;
}
```

---

## Error Codes

| Code | HTTP | Description | Recoverable |
|------|------|-------------|-------------|
| `CONTENT_NOT_FOUND` | 404 | ì½˜í…ì¸  ì—†ìŒ | âŒ |
| `CONTENT_ACCESS_DENIED` | 403 | ì ‘ê·¼ ê¶Œí•œ ì—†ìŒ | âŒ |
| `CACHE_MISS` | - | ìºì‹œ ë¯¸ìŠ¤ | âœ… (DB ì¡°íšŒ) |
| `INVALID_PAGE` | 400 | ì˜ëª»ëœ í˜ì´ì§€ | âŒ |

---

## Caching Strategy

| ë°ì´í„° | TTL | ë¬´íš¨í™” ì¡°ê±´ |
|--------|-----|------------|
| ì½˜í…ì¸  ìƒì„¸ | 10ë¶„ | ì½˜í…ì¸  ìˆ˜ì • ì‹œ |
| í•¸ë“œ ëª©ë¡ | 30ë¶„ | í•¸ë“œ ì¶”ê°€/ìˆ˜ì • ì‹œ |
| íƒ€ì„ë¼ì¸ | 1ì‹œê°„ | í•¸ë“œ ë³€ê²½ ì‹œ |
| ì½˜í…ì¸  ëª©ë¡ | 5ë¶„ | ìƒˆ ì½˜í…ì¸  ì¶”ê°€ ì‹œ |

---

## Testing

- **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: `features/content/__tests__/`
- **í†µí•© í…ŒìŠ¤íŠ¸**: `tests/integration/content/`
- **Mock ì •ì±…**: DB ì¿¼ë¦¬ Mock, Redis Mock
- **í…ŒìŠ¤íŠ¸ ë°ì´í„°**: fixtures/ í´ë” í™œìš©
