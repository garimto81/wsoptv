# Stream Domain Agent Rules

**Level**: 1 (Domain)
**Role**: HLS ìŠ¤íŠ¸ë¦¬ë° ë° íŠ¸ëœìŠ¤ì½”ë”© ê´€ë¦¬

---

## Identity

| ì†ì„± | ê°’ |
|------|-----|
| **Agent ID** | `stream-domain` |
| **Level** | 1 (Domain) |
| **Domain** | Stream |
| **Managed Blocks** | stream.resolve, stream.transcode, stream.deliver, stream.monitor |
| **Scope** | `apps/web/features/player/`, `packages/agents/stream-domain/`, Backend HLS ì„œë¹„ìŠ¤ |

---

## Block Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STREAM DOMAIN                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   resolve    â”‚â”€â”€â”€â–¶â”‚  transcode   â”‚â”€â”€â”€â–¶â”‚   deliver    â”‚  â”‚
â”‚  â”‚    Block     â”‚    â”‚    Block     â”‚    â”‚    Block     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                   â”‚                   â”‚          â”‚
â”‚         â–¼                   â–¼                   â–¼          â”‚
â”‚  â€¢ NAS ê²½ë¡œ í™•ì¸       â€¢ FFmpeg ì‹¤í–‰       â€¢ HLS ì„œë¹™     â”‚
â”‚  â€¢ ê¶Œí•œ ê²€ì¦           â€¢ ë¶„ì‚° ë½            â€¢ ì„¸ê·¸ë¨¼íŠ¸ ìºì‹œâ”‚
â”‚  â€¢ íŒŒì¼ ì¡´ì¬ í™•ì¸      â€¢ ì§„í–‰ë¥  ì¶”ì         â€¢ ABR ì²˜ë¦¬    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                           â”‚
â”‚  â”‚   monitor    â”‚                                           â”‚
â”‚  â”‚    Block     â”‚                                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                           â”‚
â”‚         â”‚                                                   â”‚
â”‚         â–¼                                                   â”‚
â”‚  â€¢ ìƒíƒœ ëª¨ë‹ˆí„°ë§                                            â”‚
â”‚  â€¢ ì—ëŸ¬ ê°ì§€                                                â”‚
â”‚  â€¢ ì¬ì‹œë„ íŠ¸ë¦¬ê±°                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Constraints

### DO (í•´ì•¼ í•  ê²ƒ)
- âœ… ëª¨ë“  ìŠ¤íŠ¸ë¦¼ ìš”ì²­ì— ì‚¬ìš©ì ê¶Œí•œ ê²€ì¦
- âœ… íŠ¸ëœìŠ¤ì½”ë”© ì „ íŒŒì¼ ì¡´ì¬ í™•ì¸
- âœ… ë¶„ì‚° ë½ìœ¼ë¡œ ì¤‘ë³µ íŠ¸ëœìŠ¤ì½”ë”© ë°©ì§€
- âœ… HLS ì„¸ê·¸ë¨¼íŠ¸ ìºì‹± ì ìš©
- âœ… ABR (Adaptive Bitrate) ì§€ì›

### DON'T (í•˜ì§€ ë§ ê²ƒ)
- âŒ ì¸ì¦ ì—†ì´ ìŠ¤íŠ¸ë¦¼ URL ìƒì„±
- âŒ **ë‹¤ë¥¸ ë„ë©”ì¸ì˜ DB í…Œì´ë¸” ì§ì ‘ ì¡°ì‘** (users, catalogs ë“±)
- âŒ **E2E í…ŒìŠ¤íŠ¸ì—ì„œ í”„ë¡œë•ì…˜ DB ì‚¬ìš©** (ë°˜ë“œì‹œ í…ŒìŠ¤íŠ¸ DB ì‚¬ìš©)
- âŒ NAS ê²½ë¡œ í´ë¼ì´ì–¸íŠ¸ ë…¸ì¶œ
- âŒ ë™ì‹œ íŠ¸ëœìŠ¤ì½”ë”© ë¬´ì œí•œ í—ˆìš©
- âŒ ì›ë³¸ íŒŒì¼ ì§ì ‘ ì„œë¹™
- âŒ ì˜êµ¬ ìºì‹œ (TTL í•„ìˆ˜)

### ğŸ“Š DB í…Œì´ë¸” ì†Œìœ ê¶Œ

| ì†Œìœ  í…Œì´ë¸” | ì½ê¸° ì „ìš© í…Œì´ë¸” |
|-------------|------------------|
| (ì—†ìŒ - íŒŒì¼ ì‹œìŠ¤í…œ/ìºì‹œë§Œ ê´€ë¦¬) | `files`, `contents` (ê²½ë¡œ ì¡°íšŒìš©) |

---

## Capabilities

| Capability | Input | Output | Description |
|------------|-------|--------|-------------|
| `getStreamUrl` | `StreamRequest` | `StreamUrl` | HLS ìŠ¤íŠ¸ë¦¼ URL íšë“ |
| `getStreamStatus` | `StreamId` | `StreamStatus` | ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ì¡°íšŒ |
| `startTranscode` | `TranscodeRequest` | `TranscodeJob` | íŠ¸ëœìŠ¤ì½”ë”© ì‹œì‘ |
| `cancelTranscode` | `TranscodeId` | `void` | íŠ¸ëœìŠ¤ì½”ë”© ì·¨ì†Œ |

---

## Dependencies

### ë‚´ë¶€ ì˜ì¡´ì„±
- `@wsoptv/types`: ê³µìœ  íƒ€ì… (`StreamConfig`, `HLSManifest`)
- `auth-domain`: ê¶Œí•œ ê²€ì¦ ìœ„ì„
- `content-domain`: íŒŒì¼ ì •ë³´ ì¡°íšŒ

### ì™¸ë¶€ ì˜ì¡´ì„±
- `ffmpeg`: íŠ¸ëœìŠ¤ì½”ë”©
- `hls.js`: í´ë¼ì´ì–¸íŠ¸ HLS ì¬ìƒ
- `redis`: ë¶„ì‚° ë½, ìºì‹œ

---

## Streaming Configuration

### ë¹„íŠ¸ë ˆì´íŠ¸ í”„ë¡œí•„
| Profile | Resolution | Bitrate | Use Case |
|---------|------------|---------|----------|
| `high` | 1080p | 5 Mbps | ë°ìŠ¤í¬í†± |
| `medium` | 720p | 2.5 Mbps | íƒœë¸”ë¦¿ |
| `low` | 480p | 1 Mbps | ëª¨ë°”ì¼ |
| `audio` | - | 128 kbps | ì˜¤ë””ì˜¤ ì „ìš© |

### HLS ì„¤ì •
```typescript
const hlsConfig = {
  segmentDuration: 6,        // ì´ˆ
  playlistSize: 10,          // ì„¸ê·¸ë¨¼íŠ¸ ìˆ˜
  targetLatency: 3,          // ì´ˆ (ë¼ì´ë¸Œìš©)
};
```

---

## Error Codes

| Code | HTTP | Description | Recoverable |
|------|------|-------------|-------------|
| `STREAM_SOURCE_ERROR` | 500 | NAS ì ‘ê·¼ ì‹¤íŒ¨ | âœ… (retry) |
| `STREAM_NOT_READY` | 503 | íŠ¸ëœìŠ¤ì½”ë”© ì¤‘ | âœ… (wait) |
| `STREAM_TRANSCODE_FAILED` | 500 | íŠ¸ëœìŠ¤ì½”ë”© ì‹¤íŒ¨ | âœ… (retry) |
| `STREAM_ACCESS_DENIED` | 403 | ìŠ¤íŠ¸ë¦¼ ê¶Œí•œ ì—†ìŒ | âŒ |
| `STREAM_NOT_FOUND` | 404 | íŒŒì¼ ì—†ìŒ | âŒ |

---

## Recovery Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STREAM_NOT_    â”‚     â”‚  Retry (3íšŒ)    â”‚     â”‚  Circuit Open   â”‚
â”‚  READY (503)    â”‚â”€â”€â”€â”€â–¶â”‚  5ì´ˆ ê°„ê²©       â”‚â”€â”€â”€â”€â–¶â”‚  (ì‹¤íŒ¨ ì‹œ)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Retry-After    â”‚
â”‚  í—¤ë” ì¤€ìˆ˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Testing

- **ë‹¨ìœ„ í…ŒìŠ¤íŠ¸**: `features/player/__tests__/`
- **í†µí•© í…ŒìŠ¤íŠ¸**: `tests/integration/stream/`
- **Mock ì •ì±…**: FFmpeg Mock, NAS Mock
- **ë¡œë“œ í…ŒìŠ¤íŠ¸**: k6 ìŠ¤í¬ë¦½íŠ¸ í™œìš©
